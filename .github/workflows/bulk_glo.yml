name: GLOBAL OnePlus Bulk OTA Archiver

on:
  workflow_dispatch:

jobs:
  process_otas:
    runs-on: ubuntu-latest
    steps:
      # -------------------------------------------------
      # 1. CHECKOUT
      # -------------------------------------------------
      - name: üì• Checkout Repo
        uses: actions/checkout@v3

      # -------------------------------------------------
      # 2. FREE DISK SPACE
      # -------------------------------------------------
      - name: üßπ Free Disk Space
        run: |
          sudo rm -rf /usr/share/dotnet || true
          sudo rm -rf /usr/local/lib/android || true
          sudo rm -rf /opt/ghc || true
          sudo docker system prune -af || true
          sudo apt-get autoremove -y
          sudo apt-get clean
          df -h

      # -------------------------------------------------
      # 3. INSTALL TOOLS
      # -------------------------------------------------
      - name: üì¶ Install Tools
        run: |
          sudo apt-get update
          sudo apt-get install -y aria2 p7zip-full

      # -------------------------------------------------
      # 4. PROCESS OTAS (THE LOOP)
      # -------------------------------------------------
      - name: üîÑ Process OTAs Loop
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          TG_TOKEN: ${{ secrets.TG_TOKEN }}
          TG_DM: ${{ secrets.TG_DM }}
        run: |
          # -------------------------------------------------------
          # CONFIGURATION: LIST YOUR OTAS HERE
          # Format: "VERSION|URL"
          # -------------------------------------------------------
          declare -a OTAS=(
            "14.1.0.320|https://gauss-opexcostmanual-eu.allawnofs.com/remove-0903f46c04b1e027049c02a49bf384a7/component-ota/24/07/19/4de0db94788c486591945b5d94142da3.zip"
            "14.1.0.330|https://gauss-opexcostmanual-eu.allawnofs.com/remove-1c2e3074fa4ab1f68f5657224b7dec72/component-ota/24/07/29/aabf8788113340ab901af939be2e746d.zip"
            "14.1.0.401|https://gauss-opexcostmanual-eu.allawnofs.com/remove-6533b997121cb7e3cf7ad4bf8f560734/component-ota/24/08/20/a059c3339b1842d8bee695939b04f473.zip"
            "14.1.0.603|https://gauss-opexcostmanual-eu.allawnofs.com/remove-31f89a80bdc65ba0855d7db0956221b9/component-ota/24/10/11/6d6e3fcbdc234679a96d9a86bbb1a42d.zip"
            "14.1.0.605|https://gauss-opexcostmanual-eu.allawnofs.com/remove-597dbf46d74d8bcb715017ec63aaacf0/component-ota/24/11/13/ba427a3adfe047a4a1fbe711df8d41ea.zip"
            "15.0.0.401|https://gauss-opexcostmanual-eu.allawnofs.com/remove-664a65e321fe478e74dbc19e01c961d6/component-ota/24/12/26/e6925bf3fe11420aaa462db6895d7b9a.zip"
            "15.0.0.500|https://gauss-opexcostmanual-sg.allawnofs.com/remove-8effbe7f2f3f02da978da0bab32c1ff3/component-ota/25/01/21/0e094e9b4a2547e58f358f5badc463ef.zip"
            "15.0.0.601|https://gauss-opexcostmanual-sg.allawnofs.com/remove-a6cd220e5a6c6b7747d579a1afdb0a2f/component-ota/25/02/26/4888c327bd1f45a4813bf3de9e82fe00.zip"
            "15.0.0.702|https://gauss-opexcostmanual-sg.allawnofs.com/remove-e6c68c18004d31d162e385c597a4b033/component-ota/25/04/07/4c784790b3e54a3abc940c62a1560ca6.zip"
            "15.0.0.1201|https://gauss-opexcostmanual-eu.allawnofs.com/remove-69e9b19a40498eac0ef64a2d7f06a59f/component-ota/25/08/11/c8d41177c04d4e46bcae94d8abbb0d59.zip"
            "15.0.0.1203|https://gauss-opexcostmanual-sg.allawnofs.com/remove-1c506384ef558ae643ca9a9c03454dc0/component-ota/25/08/26/0da3c520dfde4aa1b6fdb46b4de6336d.zip"
            "15.0.0.1301|https://gauss-opexcostmanual-eu.allawnofs.com/remove-af23089e111a7216538c891f158082db/component-ota/25/10/14/13e801d5d1d04c2393d295b87016c5aa.zip"
          )

          # -------------------------------------------------------
          # START LOOP
          # -------------------------------------------------------
          count=0
          total=${#OTAS[@]}
          
          for item in "${OTAS[@]}"; do
            count=$((count+1))
            
            # Split string
            VERSION="${item%%|*}"
            URL="${item##*|}"
            
            TAG="CPH2663GLO-${VERSION}"
            BASE_NAME="CPH2663GLO-${VERSION}"
            
            echo "---------------------------------------------------"
            echo "üöÄ Processing [$count/$total]: $TAG"
            echo "---------------------------------------------------"

            # Check if Release exists
            if gh release view "$TAG" >/dev/null 2>&1; then
              echo "‚ö†Ô∏è Release $TAG already exists. Skipping..."
              continue
            fi

            # --- DM: DOWNLOAD STARTED ---
            curl -s -X POST "https://api.telegram.org/bot$TG_TOKEN/sendMessage" \
              -d chat_id="$TG_DM" \
              -d text="‚¨áÔ∏è *Downloading Started* ($count/$total)%0AVersion: \`$VERSION\`" \
              -d parse_mode="Markdown" > /dev/null

            # 2. Download
            echo "‚¨áÔ∏è Downloading..."
            aria2c "$URL" -x16 -s16 -k1M -o ota.zip -q

            # --- DM: ZIPPING ---
            curl -s -X POST "https://api.telegram.org/bot$TG_TOKEN/sendMessage" \
              -d chat_id="$TG_DM" \
              -d text="‚úÇÔ∏è *Zipping/Splitting...*" \
              -d parse_mode="Markdown" > /dev/null

            # 3. Split
            echo "‚úÇÔ∏è Splitting..."
            mkdir -p split_output
            7z a -t7z -mx=0 -v1900m "split_output/${BASE_NAME}.7z" "ota.zip"

            # 4. Create Release
            echo "üì¶ Creating GitHub Release..."
            
            # --- NEW RELEASE NOTES FORMAT ---
            NOTES="**Region:** GLOBAL ( CPH2663GLO ) üáÆüá≥"$'\n'"**Version:** ${VERSION} üì±"$'\n'"**Type:** Official OTA üì¶"$'\n\n'"**BOOT & INIT_BOOT of this ${VERSION} can be found here :** https://t.me/boot_imgs_nord4/2"
            
            gh release create "$TAG" -t "OnePlus OTA - ${VERSION}" -n "$NOTES"

            # 5. Upload Loop (With Start/Done DMs)
            echo "üì§ Uploading assets..."
            part_num=0
            
            # Enable nullglob in case of weird file matches
            shopt -s nullglob
            
            for f in split_output/*; do
               part_num=$((part_num+1))
               fname=$(basename "$f")
               
               # --- DM: UPLOAD START ---
               curl -s -X POST "https://api.telegram.org/bot$TG_TOKEN/sendMessage" \
                -d chat_id="$TG_DM" \
                -d text="üöÄ *Upload Started*: $fname" \
                -d parse_mode="Markdown" > /dev/null

               # Upload (Force overwrite)
               gh release upload "$TAG" "$f" --clobber
               
               # --- DM: UPLOAD DONE ---
               curl -s -X POST "https://api.telegram.org/bot$TG_TOKEN/sendMessage" \
                -d chat_id="$TG_DM" \
                -d text="‚úÖ *Upload Done*: $fname" \
                -d parse_mode="Markdown" > /dev/null
            done

            # 6. Cleanup
            echo "üßπ Cleaning up..."
            rm -rf ota.zip split_output
            
            echo "‚úÖ Done with $TAG"
          done
          
          echo "üéâ All tasks finished!"

      # -------------------------------------------------
      # 5. FAILURE NOTIFICATION
      # -------------------------------------------------
      - name: ‚ùå DM ‚Äî Pipeline Failed
        if: ${{ failure() }}
        env:
          TG_TOKEN: ${{ secrets.TG_TOKEN }}
          TG_DM: ${{ secrets.TG_DM }}
        run: |
          curl -s -X POST "https://api.telegram.org/bot$TG_TOKEN/sendMessage" \
          -d chat_id="$TG_DM" \
          -d text="‚ùå *Pipeline FAILED!* Check GitHub Actions logs for details." \
          -d parse_mode="Markdown"
